{% extends 'base.html' %}

{% block title %}Поиск голосований{% endblock %}

{% block extra_css %}
.search-container {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}
.search-form {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 8px;
    flex: 1;
    min-width: 300px;
}
.search-form input, .search-form button {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}
.search-form button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    cursor: pointer;
    font-weight: bold;
    transition: transform 0.2s;
}
.search-form button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}
.results-container {
    display: flex;
    gap: 20px;
}
.poll-list {
    flex: 1;
    min-width: 300px;
}
.poll-item {
    background: #f8f9fa;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    border-left: 4px solid #667eea;
}
.poll-item:hover {
    background: #e9ecef;
    transform: translateX(5px);
}
.poll-item.active {
    background: #667eea;
    color: white;
}
.statistics-panel {
    flex: 1;
    min-width: 400px;
    background: #f8f9fa;
    padding: 25px;
    border-radius: 8px;
    min-height: 400px;
}
.statistics-panel h3 {
    margin-bottom: 20px;
    color: #333;
}
.loading {
    text-align: center;
    color: #666;
    padding: 40px;
}
.chart-container {
    margin: 20px 0;
    text-align: center;
}
.chart-container img {
    max-width: 100%;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.stats-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
}
.stats-table th, .stats-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}
.stats-table th {
    background: #667eea;
    color: white;
}
.export-buttons {
    margin-top: 20px;
    display: flex;
    gap: 10px;
}
.export-buttons button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
}
.export-buttons .btn-csv {
    background: #28a745;
    color: white;
}
.export-buttons .btn-json {
    background: #17a2b8;
    color: white;
}
.export-buttons button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
{% endblock %}

{% block content %}
<div class="search-container">
    <div class="search-form">
        <h3>Поиск голосований</h3>
        <form id="searchForm" method="get">
            <input type="text" name="q" placeholder="Поиск по тексту вопроса" value="{{ request.GET.q }}">
            <input type="date" name="date_from" placeholder="Дата начала" value="{{ request.GET.date_from }}">
            <input type="date" name="date_to" placeholder="Дата окончания" value="{{ request.GET.date_to }}">
            <button type="submit">Найти</button>
        </form>
    </div>
</div>

<div class="results-container">
    <div class="poll-list">
        <h3>Найденные голосования</h3>
        {% for poll in polls %}
        <div class="poll-item" data-poll-id="{{ poll.id }}">
            <strong>{{ poll.question }}</strong><br>
            <small>{{ poll.pub_date|date:"d.m.Y H:i" }} | Голосов: {{ poll.total_votes }}</small>
        </div>
        {% empty %}
        <p style="text-align: center; color: #666; padding: 20px;">
            Голосования не найдены. Попробуйте изменить параметры поиска.
        </p>
        {% endfor %}
    </div>
    
    <div class="statistics-panel">
        <h3>Статистика по голосованию</h3>
        <div id="statsContent" class="loading">
            Выберите голосование из списка для просмотра статистики
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const pollItems = document.querySelectorAll('.poll-item');
    const statsContent = document.getElementById('statsContent');
    
    pollItems.forEach(item => {
        item.addEventListener('click', function() {
            // Убираем активный класс со всех элементов
            pollItems.forEach(i => i.classList.remove('active'));
            // Добавляем активный класс текущему элементу
            this.classList.add('active');
            
            const pollId = this.dataset.pollId;
            loadStatistics(pollId);
        });
    });
    
    function loadStatistics(pollId) {
        statsContent.innerHTML = '<div class="loading">Загрузка статистики...</div>';
        
        // Загружаем статистику
        fetch(`/api/analytics/polls/${pollId}/statistics/`)
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                displayStatistics(data);
                loadChart(pollId);
            })
            .catch(error => {
                statsContent.innerHTML = `<div class="loading" style="color: red;">
                    <strong>Ошибка загрузки статистики</strong><br>
                    <small>${error.message}</small><br>
                    <small>Проверьте консоль браузера для подробностей</small>
                </div>`;
                console.error('Error loading statistics:', error);
            });
    }
    
    function displayStatistics(data) {
        if (!data || data.error) {
            statsContent.innerHTML = `<div class="loading" style="color: red;">
                <strong>Ошибка получения данных</strong><br>
                <small>${data?.error || 'Неизвестная ошибка'}</small>
            </div>`;
            return;
        }
        
        let html = '<div>';
        
        html += `<h4>${data.question || 'Без названия'}</h4>`;
        html += `<p><strong>Дата создания:</strong> ${data.pub_date || 'Не указана'}</p>`;
        html += `<p><strong>Всего голосов:</strong> ${data.total_votes || 0}</p>`;
        
        if (data.choices && data.choices.length > 0) {
            html += '<table class="stats-table">';
            html += '<thead><tr><th>Вариант ответа</th><th>Голосов</th><th>Процент</th></tr></thead>';
            html += '<tbody>';
            
            data.choices.forEach(choice => {
                const percentage = choice.percentage || 0;
                html += `<tr>
                    <td>${choice.choice_text || 'Без названия'}</td>
                    <td>${choice.vote_count || 0}</td>
                    <td>${percentage.toFixed(2)}%</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
        } else {
            html += '<p style="color: #999; text-align: center; padding: 20px;">У этого голосования пока нет вариантов ответа</p>';
        }
        
        if (data.poll_id) {
            html += '<div class="export-buttons">';
            html += `<button class="btn-csv" onclick="exportData(${data.poll_id}, 'csv')">Экспорт CSV</button>`;
            html += `<button class="btn-json" onclick="exportData(${data.poll_id}, 'json')">Экспорт JSON</button>`;
            html += '</div>';
        }
        
        html += '<div id="chartContainer" class="chart-container"></div>';
        html += '</div>';
        
        statsContent.innerHTML = html;
    }
    
    function loadChart(pollId) {
        const chartContainer = document.getElementById('chartContainer');
        if (!chartContainer) return;
        
        fetch(`/api/analytics/polls/${pollId}/chart/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.chart_base64) {
                    chartContainer.innerHTML = `<img src="data:image/png;base64,${data.chart_base64}" alt="Диаграмма результатов">`;
                } else if (data.chart_svg) {
                    chartContainer.innerHTML = data.chart_svg;
                } else if (data.error) {
                    chartContainer.innerHTML = `<p style="color: #999; text-align: center;">${data.error}</p>`;
                }
            })
            .catch(error => {
                console.error('Error loading chart:', error);
                if (chartContainer) {
                    chartContainer.innerHTML = '<p style="color: #999; text-align: center;">Не удалось загрузить график</p>';
                }
            });
    }
    
    window.exportData = function(pollId, format) {
        window.location.href = `/api/analytics/polls/${pollId}/export/?format=${format}`;
    };
    
    // Автоматически загружаем статистику для первого голосования, если есть результаты поиска
    if (pollItems.length > 0) {
        pollItems[0].click();
    }
});
</script>
{% endblock %}

